## 方式:
4.繼承抽象類別，避免重複方法。一.運行建立表格Script  

```SQL
CREATE TABLE [Post]([ID] [nvarchar](50) NOT NULL,[Title] [nvarchar](250) NOT NULL,[Slug] [nvarchar](250) NOT NULL,[Excerpt] [nvarchar](250) NOT NULL,[Content] [nvarchar](max) NOT NULL,[PubDate] [datetime] NULL,[LastModified] [datetime] NULL,[IsPublished] [bit] NULL,[IsMarkDown] [bit] NULL,[MarkDownContent] [nvarchar](max) NULL,CONSTRAINT [PK_Post] PRIMARY KEY CLUSTERED ([ID] ASC));

CREATE TABLE [Categories]( [PostID] [nvarchar](50) NOT NULL, [Name] [nvarchar](250) NOT NULL,CONSTRAINT [PK_Categories] PRIMARY KEY CLUSTERED (  [PostID] ASC,  [Name] ASC));

CREATE TABLE [Comment](  [ID] [nvarchar](50) NOT NULL,  [Author] [nvarchar](50) NOT NULL,  [Email] [nvarchar](50) NOT NULL,  [Content] [nvarchar](250) NOT NULL,  [PubDate] [datetime] NOT NULL,  [IsAdmin] [bit] NOT NULL,  [PostID] [nvarchar](50) NOT NULL, CONSTRAINT [PK_Comment] PRIMARY KEY CLUSTERED (  [ID] ASC));
```

![](https://i.imgur.com/JcX3DZk.png)

二.取消`Startup.cs`的`ConfigureServices`下
`services.AddSingleton<IBlogService, MSSqlBlogService>();/*SQL-Server*/`的註解  
三.註解`services.AddSingleton<IBlogService, FileBlogService>();/*XML*/`  

**結果:**

```C#
public void ConfigureServices(IServiceCollection services){
    //略..
    services.AddSingleton<IBlogService, MSSqlBlogService>();/*SQL-Server*/
    //services.AddSingleton<IBlogService, FileBlogService>();/*XML*/     
    //略..
}
```


## 原理:
MiniBlog使用預設XML做資料存取，沒有支持SQL-Server
但是提供`IBlogService`介面，可以簡單實作資料的存取。<br/>
在`Startup.cs`的`ConfigureServices`方法，
使用.NETCore AddSingleton方法依賴注射SQL實作方法


## 舉例(實作文章新增、修改方法)

一.建立MSSqlBlogService方法，實作IBlogService

```C#
public interface IBlogService
{
    //略...
    Task SavePost(Post post);
    //略...
}
```

```C#
public class MSSqlBlogService : IBlogService
```

二.建立SqlHelper輔助取得Connection
1.注意這邊使用抽象方法，避免可以被new，直接呼叫方法就可以。
![](https://i.imgur.com/S9E8JCU.png)
2.假如有大量建立連線的情況，請使用連線池。

```C#
public abstract class SqlHelper
{
    public static readonly string connectionString =
        @"連線字串"
        ;
    private static readonly System.Data.Common.DbProviderFactory dbProviderFactory = System.Data.SqlClient.SqlClientFactory.Instance;

    public static IDbConnection CreateDefaultConnection()
    {
        var conn = dbProviderFactory.CreateConnection();
        conn.ConnectionString = connectionString;
        conn.Open();
        return conn;
    }
}
```

三.實作IBlogService的保存方法(SavePost)
注意點
1.因為牽扯到多張表格交易，一定要記得包Transation(因為非同步關係，記得`TransactionScopeAsyncFlowOption.Enabled`)
2.時間需要使用UTC避免伺服器在其他時區問題
3.判斷資料是否存在使用`top 1 1`方式 (原理可以看這篇[【C#、SQL】 : 省略count判斷資料有無,直接查詢1 or Not返回boolean結果(select top 1 1)](https://ithelp.ithome.com.tw/articles/10199062))

```C#
public async Task SavePost(Post post)
{
    post.LastModified = DateTime.UtcNow;
    using (var conn = SqlHelper.CreateDefaultConnection())
    using (var ts = new TransactionScope(TransactionScopeAsyncFlowOption.Enabled))
    {
        if (conn.Query<bool>("select top 1 1 from post where id = @id", new { @id = post.ID }).SingleOrDefault())
        {
            await conn.ExecuteAsync(@"
                UPDATE Post
                SET Title = @Title,Slug = @Slug,Excerpt = @Excerpt,Content = @Content,PubDate = @PubDate,LastModified = @LastModified,IsPublished = @IsPublished
                WHERE ID = @ID
            ", post);
            await conn.ExecuteAsync(@"
                Delete Categories where PostID = @ID 
            ", post);
            var cats = post.Categories.Select(s => new { PostID = post.ID, Name = s }).ToList();
            await conn.ExecuteAsync(@"
               INSERT INTO Categories (PostID ,Name) VALUES (@PostID ,@Name);
            ", cats);
        }
        else
        {
            await conn.ExecuteAsync(@"
                INSERT INTO Post(ID,Title,Slug,Excerpt,Content,PubDate,LastModified,IsPublished)
                VALUES (@ID,@Title,@Slug,@Excerpt,@Content,@PubDate,@LastModified,@IsPublished)
            ", post);
            var cats = post.Categories.Select(s => new { PostID = post.ID, Name = s }).ToList();
            await conn.ExecuteAsync(@"
                INSERT INTO Categories (PostID ,Name) 
                VALUES (@PostID ,@Name)
            ", cats);
        }
        ts.Complete();
    }

    //略...
}
```

## 結論:
假如要使用其他資料庫，如PostgreSQL，照上述方式就可以實作功能。